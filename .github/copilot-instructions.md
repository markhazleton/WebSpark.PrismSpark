# GitHub Copilot Instructions - WebSpark.PrismSpark

## ğŸ¯ Constitution Authority

**PRIMARY REFERENCE**: [WebSpark.PrismSpark Constitution](../.documentation/memory/constitution.md) (v1.0.0, ratified 2026-02-10)

ALL code suggestions, documentation, and guidance provided by GitHub Copilot MUST comply with the project constitution. When the constitution and these instructions conflict, the constitution takes precedence.

---

## ğŸ“ File Organization Rules

### Documentation Structure (MANDATORY)

All documentation files MUST follow this organization:

```
WebSpark.PrismSpark/
â”œâ”€â”€ README.md                              # Repository root - ONLY README.md allowed here
â”œâ”€â”€ .documentation/
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â””â”€â”€ constitution.md                # Project constitution (authoritative)
â”‚   â”œâ”€â”€ docs/                              # âš ï¸ ALL non-README .md files go here
â”‚   â”‚   â”œâ”€â”€ architecture.md
â”‚   â”‚   â”œâ”€â”€ contributing.md
â”‚   â”‚   â”œâ”€â”€ deployment.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ copilot/                           # âš ï¸ ALL Copilot session outputs go here
â”‚   â”‚   â”œâ”€â”€ session-2026-02-10/
â”‚   â”‚   â”‚   â”œâ”€â”€ feature-analysis.md
â”‚   â”‚   â”‚   â”œâ”€â”€ code-review.md
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ session-2026-02-11/
â”‚   â”‚   â””â”€â”€ session-YYYY-MM-DD/            # Date format: YYYY-MM-DD
â”‚   â””â”€â”€ templates/                          # Spec/plan/task templates
â”‚       â”œâ”€â”€ spec-template.md
â”‚       â”œâ”€â”€ plan-template.md
â”‚       â””â”€â”€ tasks-template.md
```

### Copilot-Generated Documentation (MANDATORY)

**ALL** documentation, summaries, analyses, or markdown files generated by GitHub Copilot MUST be placed in:

```
.documentation/copilot/session-{YYYY-MM-DD}/
```

Where `{YYYY-MM-DD}` follows ISO 8601 date format (e.g., `session-2026-02-10`).

**Examples:**
- Feature analysis â†’ `.documentation/copilot/session-2026-02-10/feature-analysis.md`
- Code review summary â†’ `.documentation/copilot/session-2026-02-10/code-review.md`
- Architecture exploration â†’ `.documentation/copilot/session-2026-02-10/architecture-exploration.md`
- Refactoring suggestions â†’ `.documentation/copilot/session-2026-02-10/refactoring-plan.md`

**Rationale**: Copilot sessions are ephemeral and exploratory. Organizing by date enables tracking, prevents clutter, and makes it easy to archive or delete outdated AI-generated content.

### Project Documentation (MANDATORY)

**ALL** permanent project documentation (.md files) MUST be placed in:

```
.documentation/docs/
```

**Exceptions:**
- `README.md` at repository root (only .md file allowed in root)
- Template files in `.documentation/templates/`
- Constitution in `.documentation/memory/constitution.md`
- Copilot session outputs in `.documentation/copilot/session-{date}/`

**Examples:**
- Contributing guidelines â†’ `.documentation/docs/contributing.md`
- Architecture decisions â†’ `.documentation/docs/architecture.md`
- Deployment guide â†’ `.documentation/docs/deployment.md`
- API documentation â†’ `.documentation/docs/api-reference.md`
- Troubleshooting guide â†’ `.documentation/docs/troubleshooting.md`

**Rationale**: Centralized documentation improves discoverability, prevents root-level clutter, and separates permanent docs from ephemeral Copilot outputs.

---

## ğŸ›¡ï¸ Constitution Compliance Checklist

When generating code or documentation, verify compliance with these constitutional principles:

### Code Generation

- [ ] **Principle I**: All code targets .NET 10.0 (check `.csproj` files)
- [ ] **Principle II**: Public APIs include XML `<summary>` documentation comments
- [ ] **Principle III**: Nullable reference types enabled (`string?` vs `string`)
- [ ] **Principle IV**: MSTest framework for all tests (`[TestClass]`, `[TestMethod]`)
- [ ] **Principle V**: Naming conventions followed (private `_fields`, public `Properties`)
- [ ] **Principle VI**: Layer-appropriate error handling (library throws, service catches/logs)
- [ ] **Principle VII**: Code formatting follows EditorConfig (4-space indent, LF line endings)
- [ ] **Architecture**: Use file-scoped namespaces (`namespace WebSpark.PrismSpark;`)
- [ ] **Architecture**: Prefer interface-driven design for extensibility points

### Documentation Generation

- [ ] Place in correct directory (`.documentation/copilot/session-{date}/` or `.documentation/docs/`)
- [ ] Reference constitution principles where applicable
- [ ] Use relative links for internal cross-references
- [ ] Follow project markdown formatting conventions

---

## ğŸ’¡ Code Suggestions Guidelines

### Preferred Patterns

**Dependency Injection** (ASP.NET projects):
```csharp
// âœ… GOOD: Interface-driven, injectable
public class CodeHighlightingService
{
    private readonly IHighlighter _highlighter;
    private readonly ILogger<CodeHighlightingService> _logger;
    
    public CodeHighlightingService(IHighlighter highlighter, ILogger<CodeHighlightingService> logger)
    {
        _highlighter = highlighter;
        _logger = logger;
    }
}
```

**Error Handling** (Service layer):
```csharp
// âœ… GOOD: Catch, log, graceful fallback
public string HighlightCode(string code, string language)
{
    try
    {
        var grammar = LanguageGrammars.GetGrammar(language);
        return _highlighter.Highlight(code, grammar, language);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Syntax highlighting failed for language: {Language}", language);
        return $"<pre><code>{HttpUtility.HtmlEncode(code)}</code></pre>"; // Fallback
    }
}
```

**Error Handling** (Library layer):
```csharp
// âœ… GOOD: Throw meaningful exceptions
public static Grammar GetGrammar(string language)
{
    if (string.IsNullOrWhiteSpace(language))
        throw new ArgumentException("Language cannot be null or empty", nameof(language));
    
    if (!_grammars.TryGetValue(language.ToLowerInvariant(), out var grammar))
        throw new InvalidOperationException($"Grammar not found for language: {language}");
    
    return grammar;
}
```

**XML Documentation**:
```csharp
/// <summary>
/// Highlights code using the specified grammar and returns HTML with syntax highlighting.
/// </summary>
/// <param name="code">The source code to highlight.</param>
/// <param name="grammar">The language grammar definition to use for tokenization.</param>
/// <param name="language">The language identifier for CSS class generation (e.g., "csharp", "javascript").</param>
/// <returns>HTML string with tokenized and highlighted code.</returns>
/// <exception cref="ArgumentNullException">Thrown when <paramref name="code"/> or <paramref name="grammar"/> is null.</exception>
public string Highlight(string code, Grammar grammar, string language)
{
    // Implementation
}
```

### Anti-Patterns to Avoid

```csharp
// âŒ BAD: Nullable not enabled properly
public string ProcessCode(string? code) // OK
{
    return code.ToUpper(); // Warning: Possible null reference
}

// âŒ BAD: Missing XML docs on public API
public class MyHighlighter { } // Constitution Principle II violation

// âŒ BAD: Wrong naming convention
public class MyService
{
    private string myField; // Should be _myField
    public string my_property { get; set; } // Should be MyProperty
}

// âŒ BAD: Try-catch in library code (wrong layer)
public Grammar GetGrammar(string language)
{
    try
    {
        return _grammars[language];
    }
    catch
    {
        return null; // Should throw, not swallow
    }
}

// âŒ BAD: Block namespace instead of file-scoped
namespace WebSpark.PrismSpark
{
    public class MyClass { }
}
```

---

## ğŸ§ª Testing Guidelines

### Test Structure (MSTest)

```csharp
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace WebSpark.PrismSpark.Tests;

[TestClass]
public class GrammarTests
{
    [TestMethod]
    public void GetGrammar_ValidLanguage_ReturnsGrammar()
    {
        // Arrange
        var language = "csharp";
        
        // Act
        var grammar = LanguageGrammars.GetGrammar(language);
        
        // Assert
        Assert.IsNotNull(grammar);
        Assert.AreEqual("csharp", grammar.LanguageName);
    }
    
    [TestMethod]
    [ExpectedException(typeof(ArgumentException))]
    public void GetGrammar_NullLanguage_ThrowsArgumentException()
    {
        // Act
        LanguageGrammars.GetGrammar(null);
    }
}
```

**Key Requirements:**
- Use `[TestClass]` and `[TestMethod]` attributes (MSTest)
- Follow AAA pattern (Arrange-Act-Assert)
- One logical assertion per test
- Descriptive test names: `MethodName_Scenario_ExpectedResult`
- Include tests for both success and error paths

---

## ğŸ“‹ Documentation Standards

### Markdown Files

**Internal Links** (use relative paths):
```markdown
See [Constitution](../.documentation/memory/constitution.md) for governance rules.
Refer to [API Documentation](../.documentation/docs/api-reference.md) for details.
```

**Code References** (link to specific lines):
```markdown
The [Grammar class](./../WebSpark.PrismSpark/Grammar.cs#L5) defines the tokenization rules.
See [Principle II](./../.documentation/memory/constitution.md#ii-code-documentation-mandatory) for documentation requirements.
```

**Headers**:
- Use ATX-style headers (`#`, `##`, `###`)
- One H1 (`#`) per document (title)
- Maintain logical hierarchy (don't skip levels)

**Code Blocks**:
````markdown
```csharp
// Use language identifiers for syntax highlighting
public class Example { }
```
````

---

## ğŸ”„ Workflow Integration

### When Creating Documentation

1. **Determine Type**: Is this ephemeral (Copilot exploration) or permanent (project docs)?
2. **Choose Location**:
   - Ephemeral â†’ `.documentation/copilot/session-{today's date}/`
   - Permanent â†’ `.documentation/docs/`
3. **Create Directory**: If session folder doesn't exist, create it
4. **Name File**: Use descriptive kebab-case names (`feature-analysis.md`, not `Analysis.md`)
5. **Add Frontmatter** (optional but recommended):
   ```markdown
   ---
   generated: 2026-02-10
   session: copilot-chat
   purpose: Feature analysis for enhanced syntax highlighting
   ---
   ```

### When Suggesting Code Changes

1. **Check Constitution**: Does suggestion comply with all principles?
2. **Verify Context**: Is this library layer (throw) or service layer (catch/log)?
3. **Include Documentation**: Add XML docs for public APIs
4. **Format Correctly**: Follow EditorConfig rules (4-space indent, LF endings)
5. **Test Coverage**: If adding public API, suggest corresponding test

---

## ğŸš¨ Critical Reminders

### DO:
âœ… Always reference the constitution for authoritative guidance  
âœ… Place all Copilot-generated docs in `.documentation/copilot/session-{date}/`  
âœ… Place all project docs in `.documentation/docs/`  
âœ… Include XML docs on all public APIs  
âœ… Use nullable reference types correctly  
âœ… Write MSTest tests for new features  
âœ… Follow file-scoped namespace pattern  
âœ… Use dependency injection in ASP.NET projects  

### DON'T:
âŒ Create .md files in repository root (except README.md)  
âŒ Mix Copilot session outputs with permanent documentation  
âŒ Suggest code that violates constitution principles  
âŒ Use block namespaces instead of file-scoped  
âŒ Add try-catch in library code (wrong layer)  
âŒ Omit XML documentation on public APIs  
âŒ Disable nullable reference types  
âŒ Suggest tests using frameworks other than MSTest  

---

## ğŸ“š Quick Reference Links

- [Constitution](../.documentation/memory/constitution.md) - Authoritative governance and principles
- [Spec Template](../.documentation/templates/spec-template.md) - Feature specification format
- [Plan Template](../.documentation/templates/plan-template.md) - Implementation planning format
- [Tasks Template](../.documentation/templates/tasks-template.md) - Task breakdown format
- [Repository README](../README.md) - Project overview and getting started

---

## ğŸ“ Version

**Instructions Version**: 1.0.0  
**Aligned with Constitution**: v1.0.0 (2026-02-10)  
**Last Updated**: 2026-02-10

When the constitution is amended, these instructions MUST be reviewed for alignment.
